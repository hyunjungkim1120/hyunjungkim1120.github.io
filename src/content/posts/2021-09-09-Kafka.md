---
title: Kafka
template: blog-post
tags: [ Kafka ]
date: 2021-09-09T05:25:44.226Z
slug: /kafka
featuredImage: /assets/Kafka/kafka.png
description: Apache Kafka ê°œë…ì´í•´ ë° ì‚¬ìš© (c#)

---



## Apache Kafka

ì¹´í”„ì¹´ë¥¼ ê²€ìƒ‰í•˜ë©´ ë‚˜ì˜¤ëŠ” ì„¤ëª…ì€ ì•„ë˜ì™€ ê°™ë‹¤.

 *ì•„íŒŒì¹˜ ì¹´í”„ì¹´ëŠ” ì•„íŒŒì¹˜ ì†Œí”„íŠ¸ì›¨ì–´ ì¬ë‹¨ì´ ìŠ¤ì¹¼ë¼ë¡œ ê°œë°œí•œ ì˜¤í”ˆ ì†ŒìŠ¤ ë©”ì‹œì§€ ë¸Œë¡œì»¤ í”„ë¡œì íŠ¸ì´ë‹¤.*
*ì´ í”„ë¡œì íŠ¸ëŠ” ì‹¤ì‹œê°„ ë°ì´í„° í”¼ë“œë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ í†µì¼ëœ, ë†’ì€ ì²˜ë¦¬ëŸ‰, ë‚®ì€ ì§€ì—°ì‹œê°„ì„ ì§€ë‹Œ í”Œë«í¼ì„ ì œê³µí•˜ëŠ” ê²ƒì´ ëª©í‘œì´ë‹¤.*

ğŸ’¡ **ì‰½ê²Œ ë§í•´ì„œ ì¹´í”„ì¹´ëŠ” ë¶„ì‚°í™˜ê²½ì— íŠ¹í™”ë˜ì–´ìˆëŠ” "ë©”ì‹œì§€ í" ì´ë‹¤.**

</br>

</br>

</br>

Kafkaì™€ í•¨ê»˜ ìì£¼ ì–¸ê¸‰ë˜ëŠ” ë©”ì‹œì§• ì‹œìŠ¤í…œì€ RabbitMQ, ActiveMQ ë“±ì´ ìˆë‹¤. ì ê¹ Kafkaë¥¼ ë‹¤ë¥¸ ë©”ì‹œì§• ì‹œìŠ¤í…œê³¼ ë¹„êµí•´ë³´ê³  ë„˜ì–´ê°€ì.

* KafkaëŠ” Message Brokerê°€ Consumerì—ê²Œ ë©”ì‹œì§€ë¥¼ pushí•˜ëŠ” ë°©ì‹ì˜ RabbitMQì™€ëŠ” ë‹¬ë¦¬ Consumerê°€ Brokerë¡œ ë¶€í„° ë©”ì‹œì§€ë¥¼ Pullí•˜ëŠ” ë°©ì‹ì´ë‹¤. Consumerê°€ ë©”ì‹œì§€ë¥¼ Pullí•˜ëŠ” ì¹´í”„ì¹´ì˜ ë°©ì‹ì€ Consumerì—ê²Œ ë¶€í•˜ë¥¼ ìƒëŒ€ì ìœ¼ë¡œ ëœ ì£¼ë©° ConsumerëŠ” ìì‹ ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ ë•Œ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ë¯€ë¡œ ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
* ë§ì€ ì‚¬ëŒë“¤ì´ ê³µí†µì ìœ¼ë¡œ ë§í•˜ëŠ” kafka ì˜ ì¥ì ì€ í¬ê²Œ **1.ë°ì´í„°ì˜ ì˜ì†ì„± ë³´ì¥ 2. ë©”ì‹œì§€ ìœ ì‹¤ìœ„í—˜ì´ ì ê³  ì—ëŸ¬ë³µêµ¬ìš©ì´, ì‹¤ì‹œê°„ ë¡œê·¸ì²˜ë¦¬ì— íŠ¹í™”** ë¼ê³  ì´ì•¼ê¸°í•œë‹¤. 

</br>

</br>

ì¹´í”„ì¹´ì˜ êµ¬ì„±ìš”ì†Œë¡œëŠ” í¬ê²Œ **Producer, Consumer, Event , Topic** ìœ¼ë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.

</br>

</br>

**Producer**  : ì›í•˜ëŠ” **Topic**ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤. 

**Consumer** : ë ˆì½”ë“œ/ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì—”í„°í‹°ì´ë‹¤. ì—¬ëŸ¬ê°œì˜ Consumerê°€ ê·¸ë£¹ ë¬¶ì–´ì„œ êµ¬ì„±ë˜ì–´ìˆìœ¼ë©° í•˜ë‚˜ì˜ Consumer ê·¸ë£¹ì€ í•˜ë‚˜ì˜ Topicì—ë§Œ ì ‘ê·¼í•˜ì—¬ ë©”ì„¸ì§€ë¥¼ Pull í•œë‹¤.

- ì—¬ê¸°ì„œ Topic ê¸°ì¤€ìœ¼ë¡œ ìƒê°í•˜ë©´ ì—¬ëŸ¬ê°œì˜ Consumer ê·¸ë£¹ì´ í•˜ë‚˜ì˜ í† í”½ì„ êµ¬ë…í•  ìˆ˜ ìˆë‹¤!

**Topic** : Apache Kafka ë° ê¸°íƒ€ ë©”ì‹œì§• ì†”ë£¨ì…˜ì—ì„œ í† í”½ì€ ë©”ì‹œì§€ì— ëŒ€í•œ ê´€ì‹¬ì„ í‘œì‹œí•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì£¼ì†Œ ì§€ì •ì´ ê°€ëŠ¥í•œ ì¶”ìƒí™” ê³„ì¸µì´ë‹¤. í† í”½ì€ ê²Œì‹œ(Publish) ë° êµ¬ë…(Subscribe)í•  ìˆ˜ ìˆë‹¤.

ë‹¤ì‹œí•œë²ˆ ì‰½ê²Œ í’€ì–´ì„¤ëª…í•˜ìë©´ ProducerëŠ” ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ê³  ConsumerëŠ” ë©”ì„¸ì§€ë¥¼ êº¼ë‚´ì˜¨ë‹¤!

</br>

![kafka_example](/assets/Kafka/kafka_example.png)





</br>

https://github.com/confluentinc/examples/tree/6.2.0-post/clients/cloud

í•´ë‹¹ ì£¼ì†Œì— ê° ì–¸ì–´ì— ë§ëŠ” ìƒ˜í”Œ ì½”ë“œë¥¼ ì°¸ê³ í•˜ì—¬ ê°ìì˜ ìƒí™©ì— ë§ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

</br>

</br>

ì•„ë˜ëŠ” C#ìœ¼ë¡œ ì¹´í”„ì¹´ Cunsumerë¥¼ ì‘ì„±í•œ ì˜ˆì‹œì´ë‹¤. Confluent.Kafka 1.7.0ì„ Nugetì—ì„œ ë‹¤ìš´ë°›ì•˜ë‹¤. ê·¸ë¦¬ê³  ë”°ë¡œ ConsumerConfig íŒŒì¼ì„ ì‘ì„±í•˜ì—¬ ì„¤ì • ê°’ë“¤ì„ ì‘ì„±í•˜ì˜€ë‹¤. ë§Œì•½ ë”°ë¡œ ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤ë©´ region ConsumerConfig ê°€ì ¸ì˜¤ê¸° ~endregion ë¶€ë¶„ì— ê°ê° í•´ë‹¹ ë³€ìˆ˜ì— ê°’ì„ í• ë‹¹í•˜ë©´ ëœë‹¤.

</br>

```c#
public Task GetKafkaMessage()
        {
            #region ConsumerConfig ê°€ì ¸ì˜¤ê¸°
            var config = new ConsumerConfig
            {
                GroupId = _configuration.GetValue<string>("KafkaConfig:GroupId"),
                BootstrapServers = _configuration.GetValue<string>("KafkaConfig:BootstrapServers"),
                SaslUsername = _configuration.GetValue<string>("KafkaConfig:SaslUsername"),
                SaslPassword = _configuration.GetValue<string>("KafkaConfig:SaslPassword"),
                SecurityProtocol = (SecurityProtocol)Enum.Parse(typeof(SecurityProtocol), _configuration.GetValue<string>("KafkaConfig:SecurityProtocol")),
                SaslMechanism = (SaslMechanism)Enum.Parse(typeof(SaslMechanism), _configuration.GetValue<string>("KafkaConfig:SaslMechanism")),
                AutoOffsetReset = (AutoOffsetReset)Enum.Parse(typeof(AutoOffsetReset), _configuration.GetValue<string>("KafkaConfig:AutoOffsetReset")),

            };
            #endregion ConsumerConfig ê°€ì ¸ì˜¤ê¸°

            using (var consumer = new ConsumerBuilder<string, string>(config)
                .SetErrorHandler((_, e) => _logger.LogWarning($"Error: {e.Reason}"))
                .Build())
            {
                string topic = _configuration.GetValue<string>("KafkaConfig:topic");
                consumer.Subscribe(topic);

                List<string> InsertDataList = new List<string>();
                String message = "";
                DateTime LastUpdateDate = DateTime.Now;

                try
                {
                    while (true)
                    {
                        try
                        {
                            #region ì¼ì •ì‹œê°„, listQty ì´ˆê³¼ì‹œ ë¡œê·¸
                            TimeSpan diffDate = DateTime.Now - LastUpdateDate;

                            //ë§ˆì§€ë§‰ updateì‹œê°„ì´ 3ì´ˆ ì§€ë‚¬ê±°ë‚˜ ë°ì´í„°ê°€ 10ê±´ì´ìƒì´ë©´
                            if (InsertDataList.Count>0 && (diffDate.Seconds > 3 || InsertDataList.Count >= 10))
                            {
                                foreach (var data in InsertDataList)
                                {
									_logger.LogInformation(data);
                                }
                                InsertDataList.Clear();
                            }
                            #endregion ì¼ì •ì‹œê°„, listQty ì´ˆê³¼ì‹œ ë¡œê·¸

                            var consumeResult = consumer.Consume(5000);
                           
                            //brokerì—ì„œ ê°€ì ¸ì˜¨ dataê°€ ìˆëŠ” ê²½ìš°
                            if(consumeResult != null)
                            {
                                message = consumeResult.Value;
                                InsertDataList.Add(message);
                            }
                        }
                        catch (ConsumeException e)
                        {
                            _logger.LogWarning($"Error occurred: {e.Error.Reason}");
                        }
                    }
                }
                catch (Exception e)
                {
                    _logger.LogWarning($"Exception occurred: {e.Message}");
                    consumer.Close();
                }
            }
            return Task.CompletedTask;
        }
```

</br>

</br>

</br>

Producerë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë¶€ë¶„ì€ Serilogë¡œ ë¡œê·¸ë¥¼ ì „ì†¡í•˜ì˜€ë‹¤.

- Serilog >v2.9.0
- Serilog.Sinks.PeriodicBatching >v2.3.0
- Confluent.Kafka >v1.6.3

ìœ„ì˜ ì¡°ê±´ì„ ì¤€ìˆ˜í•˜ì—¬ íŒ¨í‚¤ì§€ë¥¼ ë°›ê³  ì•„ë˜ì²˜ëŸ¼ ì„¤ì • í›„ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ë¡œê·¸ë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤.

```c#
try
{
	//kafka Log ì „ì†¡ ì„¤ì •
	kafkaLogger = new LoggerConfiguration()
				.WriteTo.Kafka(
						batchSizeLimit: 10, period: 2,
                        topic: "log-events",
                        bootstrapServers: "ì„œë²„ ì£¼ì†Œ", 
                        saslMechanism: SaslMechanism.Plain,
                        securityProtocol: SecurityProtocol.SaslPlaintext,
                        saslUsername: "$ConnectionString",
                        saslPassword: "my-event-hub-instance-connection-string"
                    .CreateLogger();
} catch (Exception ex)
{
	_logger.Warning("kafka connection error, Message : {0}", ex.Message);
}
```

</br>

#### Parameters

- **bootstrapServers** - Comma separated list of Kafka Bootstrap Servers. Defaults to "localhost:9092"
- **batchSizeLimit** - Maximum number of logs to batch. Defaults to 50
- **period** - The period in seconds to send batches of logs. Defaults to 5 seconds
- **securityProtocol** - SecurityProtocol.Plaintext
- **saslMechanism** - The SASL Mecahnism. Defaults to SaslMechanism.Plain
- **topic** - Name of the Kafka topic. Defaults to "logs"
- **topicDecider** - Alternative to a static/constant "topic" value. Function that can be used to determine the topic to be written to at runtime (example below)
- **saslUsername** - (Optional) Username for SASL. This is required for Azure Event Hubs and should be set to `$ConnectionString`
- **saslPassword** - (Optional) Password for SASL. This is required for Azure Event Hubs and is your entire Connection String.
- **sslCaLocation** - (Optional) Location of the SSL CA Certificates This is required for Azure Event Hubs and should be set to `./cacert.pem` as this package includes the Azure carcert.pem file which is copied into your binary output directory.
- **formatter** - optional `ITextFormatter` you can specify to format log entries. Defaults to the standard `JsonFormatter` with `renderMessage` set to `true`.

</br>

</br>

</br>

ì‚¬ì‹¤ ë” ê¹Šê²Œ ì•Œê³ ì í•˜ë©´ KafkaëŠ” Commit Offsetì„ ì–´ë–»ê²Œ ì œì–´í•˜ëŠ”ê°€ë¡œ ì „ë‹¬ë³´ì¦ì„ í™•ì‹¤íˆ ì œì–´í•˜ê¸°ë„ í•˜ëŠ” ë“± 

ìì„¸íˆ ì•Œê³  ì“¸ìˆ˜ë¡ ëŒ€ê·œëª¨ ë°ì´í„° ì²˜ë¦¬ë‚˜ ì‘ë‹µì†ë„ê°€ ì¤‘ìš”í•œ ì„œë¹„ìŠ¤ì—ì„œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤!

</br>

í•˜ë‹¨ì˜ ì£¼ì†ŒëŠ” Kafkaë¥¼ ì´í•´í•˜ëŠ”ë° ìˆì–´ì„œ ìœ ìš©í•œ ë§í¬ì´ë‹¤.

https://t3guild.com/2020/04/18/kafka-%ea%b0%9c%ec%9a%94/



</br>
